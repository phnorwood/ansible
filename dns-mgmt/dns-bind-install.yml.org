---
- name: install bind dns requirements
  hosts: "{{ dns_host }}"
  include: dns-config.yml
  tasks:

    - name: install bind
      yum: 
        name: "{{ item }}"
        state: latest
      with_items: "{{ dns_packages }}"

    - name: configure firewall
      firewalld: 
        service: dns
        state: enabled
        permanent: true
        zone: public
      notify: restart_firewalld

    - name: clear resolv.conf
      file: 
        path: /etc/resolv.conf
        state: absent

    - name: update resolv.conf
      copy: 
        content: | 
	  "{{ dns_search }}
	  {{ dns_nameserver }}"
        dest: /etc/resolv.conf

    - name: update NetworkManager.conf
      lineinfile: 
        path: /etc/NetworkManager/NetworkManager.conf
        line: "dns=none"
        insertafter: '\[main\]'
        state: present
      notify: reload_network_manager

    - name: enable named
      service: 
        name: named
        enabled: true
        state: started

  handlers:
    - name: restart_firewalld
      service:
        name: firewalld
        state: restarted

    - name: reload_network_manager
      service:
        name: NetworkManager
        state: reloaded
